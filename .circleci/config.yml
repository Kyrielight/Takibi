# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

executors:
  publisher:
    environment:
      PLATFORMS: linux/amd64,linux/arm64
      IMAGE_NAME: kyrielight/takibi
    docker:
      - image: cimg/base:stable
    resource_class: small

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build-image:
    executor: publisher
    docker:
      - image: cimg/base:stable
    steps:
      - setup_remote_docker:
          version: 20.10.11
      - checkout
      - run:
          name: Prepare Buildx Context
          command: |
            docker context create buildx-build
            docker buildx create --use buildx-build
            docker buildx build --platform $PLATFORMS .
      - run:
          name: Build Takibi
          command: |
            docker buildx build -t $IMAGE_NAME:latest --platform $PLATFORMS .
  deploy:
    executor: publisher
    resource_class: small
    steps:
      - setup_remote_docker:
          version: 20.10.11

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build:
    jobs:
      - build-image
      - deploy:
          filters:
            branches:
              # Only deploy to Docker Hub on a merge into main.
              only: main
          context:
            - dockerhub
